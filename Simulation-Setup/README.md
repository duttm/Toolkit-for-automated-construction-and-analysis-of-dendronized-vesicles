# Simulation Workflow for Accelerated Materials Discovery

We have built an automated framework to explore a materials design space. Currently, the framework can consider only 2 features in a single run. 

We study dendronized vesicles: these are spherical nanoparticles that consist of mixtures of DPPC lipids and dendron-grafted amphiphiles.

What are dendron-grafted amphiphiles?: These are amphiphilic biomolecules that have a hydrophilic section consisting of a branched polymer (dendron), and a hydrophobic section consisting of lipid-like tails. 

Click [here](https://doi.org/10.1039/D0NA00773K) for our first publication on dendronized vesicles. 

The materials design space of dendronized vesicles is studied as a function of the relative concentration of dendrons and the generation of the dendrons (size of the branched polymer). 

## Motivation for building an automated framework

1. High number of simulations: We study 6 generations of dendron-grafted amphiphiles (Generation 1 (G1) through Generation 6 (G6)). For each generation, we vary the concentration of dendrons. We start with a low value of concentration, and gradually increase it until stable vesicles are not observed. The final goal is to identify the threshold concentration of dendrons that yield stable vesicles. Hence, if we chose around 10 concentration values for each generation, we run approximately 60 (6 X 10) simulations. Further, each model needs to be replicated 4 times for statistical significance. Therefore, we run a total of 240 simulations (60 X 4). This is a very large number of simulations that cannot be controlled individually. 

2. Simulation setup is not straightforward: Vesicles are generated by a process known as membrane closing. Essentially, we start with a *FLAT* bilayer and let it bend to form a *SPHERICAL* vesicle during the course of long MD simulations. The entire process is divided into 4 stages: <br>

   a. Initial bilayer setup (System size: 100,000 particles and Cores: 4) <br>
   b. Bilayer production  phase (System size: 100,000 particles and Cores: 32) <br>
   c. Bilayer to Vesicle transition (System size: 1,000,000 particles and Cores: 4) <br>
   d. Vesicle production phase (System size: 1,000,000 particles and Cores: 128) <br>
   
3. Long run times: Each simulation takes around 6 days to complete.    

Due to these challenges, we developed an automated framework to simplify the process of managing these simulations. 

## Prerequisites for running the framework:

Python (import sys and os libraries) <br>
An anaconda session on a HPC machine  

## Framework tested on: 

Python versions 3.6.8 and 3.8.10 <br>
Supercomputers: TACC-Stampede2 and SDSC-Expanse

## Programming languages used: 

Python <br>
Linux shell scirpting <br>
Slurm scripts <br>

General code execution workflow: A parent python script acts a wrapper around a collection of shell, python, slurm scripts

## Launching instructions

1.  Fill up the data points file. A sample is provided in the `examples` directory (`datapoints_G3.int`). Please enter the following information in the data points file: 

Input feature  | Sample Input
| :---: |:---: 
What is the generation?  | G3
What is the name of the base file? (The file that contains simulations files  that does not depend on the concentration and generation of dendrons)  | G3_BASE
Number of data points (number of concentration values/models you want to generate) | 5
Grid spacing (a larger value would generate a larger concentration of dendrons) | 5,10,11,12,13
ions per dendron | 0
Relaxation gap (a gap between the dendrons and the lipid bilayer; needed for initial energy minimization algorithm to work) | 1.5,1.5,1.5,1.5,1.5

&emsp; The inputs for `Number of data points` and `Relaxation gap` needs to be separated by commas. 

2. Execute Stage 1 (initial bilayer setup) using: 
```
python stage1-sim-launcher.py <name of data points file>
```
&emsp; Expected run time with 4 cores: 1 day


3. Execute Stage 2 (bilayer production) using: 
```
python stage2-sim-launcher.py
```
&emsp; Expected run time with 32 cores: 1.5 day


4. Execute Stage 3 (bilayer to vesicle) using: 
```
python stage3-sim-launcher.py
```
&emsp; Expected run time with 4 cores: 1 day


5. Execute Stage 4 (vesicle production) using: 
```
python stage4-sim-launcher.py
```
&emsp; Expected run time with 128 cores: 2 day

The last stage can be extended as per the need. 

## How does the code work? 


The code generates a framework to launch multiple simulations simultaneously. Each simulation can take around 6 days to complete. Generally, supercomputers provide a 2 day limit for each simulation. Hence, we divide simulations into 4 stages for easy management on supercomputers. The pseudo code for stage 1 is: 

```
Func Stage1( Dendron generation, Dendron concentration) 

{ ## This is a representative function for stage 1. The user provides 2 variables as inputs: the dendron generation and concentration. 

Take a flat bilayer consisting of DPPC lipids
Insert the desired number of dendrons (depending on the dendron generation and concentration entered by the user)
Add water along the z dimension
Add ions 
Generate new simulation files for the modified bilayer
Look for default simulation input files and parameters
Run a gromacs simulations with 4 cores
}
```
At the end of stage 1, a mixed bilayer with DPPC lipids and dendron-grafted amphiphiles is generated. Now, stage 2 is required to equilibrate the bilayer (resolve the relaxed configuration of the bilayer). Here is the pseudo code for Stage 2: 

```
Func Stage2()

{ ## This is a representative function for stage 2.

Look for the final bilayer configuration generated in stage 1
Look for simulation files and parameters
Run gromacs simulation with 32 cores 
}
```
At the end of stage 2, an equilibrated bilayer is generated. This bilayer has a flat topology. To generate a spherical vesicle, we need to bend the bilayer. This is done by exposing the hydrophobic residues on the edges of the bilayer to water (hydrophilic). The repulsive interactions between hydrophobic and hydrophilic residues forces the bilayer to bend over the course of long MD simulations. Here is the pseudo code for Stage 3: 

```   
Func Stage3()

{ ## This is a representative function for stage 3.

Look for final bilayer configuration generated in stage 2
Add water in x, y and z dimensions
Add anti-freeze particles to avoid freezing of water 
Look for simulation files and parameters
Run gromacs simulation with 4 cores
}
```

At the end of stage 3, the bilayer is completely exposed to water (from all sides). Now, stage 4 is executed to extend the simulation over very long periods of time. Here is the pseudo code for Stage 4

```
Func Stage4()

{ ## This is a representative function for stage 3.

Look for final bilayer configuration generated in stage 3
Look for simulation files and parameters
Run gromacs simulation with 128 cores over 2 days
}
```
At the end of Stage 4, a spherical vesicle is obtained. 

## Examples 

Please refer to the `Examples` directory. There are 2 examples: 
1. G3-Basic-pH: This run has been tried and tested on SDSC-Expanse (an XSEDE supercomputer with 128 cores in 1 node). It was used to run simulations for all generations (G1 through G6). This means that this folder originally contained hundreds of files. We have just preserved a data point for G3 dendrons in this examples directory. 

2. G1-Acidic-pH: This has not been tested with the current framework. The only differenece is the pH of the systems. This will be tested in the future.  
